---
interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-brand">
        <a href="/">Nequi SDK Test</a>
      </div>
      <div class="nav-links">
        <a href="/qr">QR</a>
        <a href="/payments">Payments</a>
        <a href="/subscriptions">Subscriptions</a>
        <a href="/dispersions">Dispersions</a>
        <a href="/reports">Reports</a>
      </div>
      <div class="nav-status" id="nav-status"></div>
    </nav>

    <!-- Credentials Modal (shown in production when not authenticated) -->
    <div id="credentials-modal" class="modal hidden">
      <div class="modal-content">
        <h2>Enter Your Nequi Credentials</h2>
        <p class="hint">
          Your credentials are stored in your browser's session only and are
          never saved on the server. Environment is always sandbox for testing.
        </p>
        <form id="credentials-form">
          <div class="form-group">
            <label for="cred-clientId">Client ID</label>
            <input
              type="text"
              id="cred-clientId"
              name="clientId"
              placeholder="Your Nequi Client ID"
              required
            />
          </div>
          <div class="form-group">
            <label for="cred-clientSecret">Client Secret</label>
            <input
              type="password"
              id="cred-clientSecret"
              name="clientSecret"
              placeholder="Your Nequi Client Secret"
              required
            />
          </div>
          <div class="form-group">
            <label for="cred-apiKey">API Key</label>
            <input
              type="password"
              id="cred-apiKey"
              name="apiKey"
              placeholder="Your Nequi API Key"
              required
            />
          </div>
          <div class="form-actions">
            <button type="submit">Save Credentials</button>
          </div>
          <div id="cred-message"></div>
        </form>
      </div>
    </div>

    <main class="container">
      <slot />
    </main>
  </body>
</html>

<script is:inline>
  // Credentials management for production mode
  const STORAGE_KEY = "nequi_credentials";

  window.NequiCredentials = {
    get: function () {
      const stored = sessionStorage.getItem(STORAGE_KEY);
      if (!stored) return null;
      try {
        return JSON.parse(stored);
      } catch {
        return null;
      }
    },

    set: function (credentials) {
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(credentials));
    },

    clear: function () {
      sessionStorage.removeItem(STORAGE_KEY);
    },

    isSet: function () {
      return this.get() !== null;
    },
  };

  // API helper that includes credentials automatically
  window.nequiApi = async function (endpoint, data = {}) {
    const credentials = window.NequiCredentials.get();
    const body = credentials ? { credentials, ...data } : data;

    const response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    return response.json();
  };

  // Check configuration on page load
  async function checkConfiguration() {
    const response = await fetch("/api/health");
    const health = await response.json();

    const statusEl = document.getElementById("nav-status");
    const modal = document.getElementById("credentials-modal");

    if (health.isProduction) {
      // Production mode - check if credentials are in sessionStorage
      if (window.NequiCredentials.isSet()) {
        if (statusEl) {
          statusEl.innerHTML =
            '<span class="status-badge configured">Sandbox Mode</span>';
        }
        modal?.classList.add("hidden");
      } else {
        if (statusEl) {
          statusEl.innerHTML =
            '<button onclick="showCredentialsModal()" class="btn-small">Set Credentials</button>';
        }
        modal?.classList.remove("hidden");
      }
    } else {
      // Development mode - use .env.local
      if (health.isConfigured) {
        if (statusEl) {
          statusEl.innerHTML =
            '<span class="status-badge configured">Dev Mode (env)</span>';
        }
      } else {
        if (statusEl) {
          statusEl.innerHTML =
            '<span class="status-badge not-configured">Not Configured</span>';
        }
      }
      modal?.classList.add("hidden");
    }

    window.isProduction = health.isProduction;
    window.isConfigured = health.isConfigured;
  }

  function showCredentialsModal() {
    document.getElementById("credentials-modal")?.classList.remove("hidden");
  }

  function hideCredentialsModal() {
    document.getElementById("credentials-modal")?.classList.add("hidden");
  }

  // Handle credentials form submission
  document.addEventListener("DOMContentLoaded", function () {
    checkConfiguration();

    const form = document.getElementById("credentials-form");
    form?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const credentials = {
        clientId: formData.get("clientId"),
        clientSecret: formData.get("clientSecret"),
        apiKey: formData.get("apiKey"),
      };

      const messageEl = document.getElementById("cred-message");

      // Validate format
      const result = await fetch("/api/auth/validate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ credentials }),
      });

      const response = await result.json();

      if (response.success) {
        window.NequiCredentials.set(credentials);
        if (messageEl) {
          messageEl.innerHTML =
            '<div class="message success">Credentials saved!</div>';
        }
        setTimeout(function () {
          hideCredentialsModal();
          checkConfiguration();
        }, 1000);
      } else {
        if (messageEl) {
          messageEl.innerHTML =
            '<div class="message error">Invalid credentials: ' +
            response.message +
            "</div>";
        }
      }
    });
  });
</script>

<style is:global>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --primary: #e91e63;
    --primary-dark: #c2185b;
    --success: #4caf50;
    --error: #f44336;
    --bg: #f5f5f5;
    --card-bg: #ffffff;
    --text: #212121;
    --text-muted: #757575;
    --border: #e0e0e0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .navbar {
    background: var(--primary);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    gap: 1rem;
  }

  .nav-brand a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    font-size: 1.25rem;
  }

  .nav-links {
    display: flex;
    gap: 1.5rem;
    flex: 1;
    justify-content: center;
  }

  .nav-links a {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .nav-links a:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .nav-status {
    display: flex;
    align-items: center;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  h1 {
    margin-bottom: 1.5rem;
    color: var(--text);
  }

  h2 {
    margin-bottom: 1rem;
    color: var(--text);
    font-size: 1.25rem;
  }

  .card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text);
  }

  input,
  select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  input:focus,
  select:focus {
    outline: none;
    border-color: var(--primary);
  }

  button,
  .btn-small {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-small {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  button:hover,
  .btn-small:hover {
    background: var(--primary-dark);
  }

  button:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
  }

  .message {
    padding: 1rem;
    border-radius: 4px;
    margin-top: 1rem;
  }

  .message.success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
  }

  .message.error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
  }

  .result {
    background: #263238;
    color: #a5d6a7;
    padding: 1rem;
    border-radius: 4px;
    font-family: "Monaco", "Menlo", monospace;
    font-size: 0.875rem;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 1rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .status-badge.configured {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .status-badge.not-configured {
    background: #ffebee;
    color: #c62828;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .hint {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  code {
    background: #eceff1;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-family: "Monaco", "Menlo", monospace;
    font-size: 0.875rem;
  }

  pre {
    background: #263238;
    color: #eceff1;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
  }

  pre code {
    background: transparent;
    padding: 0;
  }

  /* Modal styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-content h2 {
    margin-bottom: 0.5rem;
  }

  .modal-content .hint {
    margin-bottom: 1.5rem;
  }

  .form-actions {
    margin-top: 1.5rem;
  }

  .form-actions button {
    width: 100%;
  }
</style>
